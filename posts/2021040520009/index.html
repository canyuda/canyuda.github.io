<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JetCache的使用 | 灿若繁星</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="JetCache是一个基于Java的缓存系统封装, 提供统一的API和注解来简化缓存的使用, 可以支持:  TTL 两级缓存 分布式自动刷新 通过注解创建并配置缓存 缓存使用的统计 Key生成策略与Value序列化方式自定义 异步CacheAPI Spring Boot支持">
<meta property="og:type" content="article">
<meta property="og:title" content="JetCache的使用">
<meta property="og:url" content="http://blog.canyuda.top/posts/2021040520009/index.html">
<meta property="og:site_name" content="灿若繁星">
<meta property="og:description" content="JetCache是一个基于Java的缓存系统封装, 提供统一的API和注解来简化缓存的使用, 可以支持:  TTL 两级缓存 分布式自动刷新 通过注解创建并配置缓存 缓存使用的统计 Key生成策略与Value序列化方式自定义 异步CacheAPI Spring Boot支持">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-05T12:57:20.000Z">
<meta property="article:modified_time" content="2024-02-07T02:34:17.564Z">
<meta property="article:author" content="灿若繁星先生">
<meta property="article:tag" content="缓存">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="灿若繁星" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">灿若繁星</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人空间</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.canyuda.top"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2021-04-JetCache的使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/posts/2021040520009/" class="article-date">
  <time class="dt-published" datetime="2021-04-05T12:57:20.000Z" itemprop="datePublished">2021-04-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      JetCache的使用
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>JetCache是一个基于Java的缓存系统封装, 提供统一的API和注解来简化缓存的使用, 可以支持:</p>
<ol>
<li>TTL</li>
<li>两级缓存</li>
<li>分布式自动刷新</li>
<li>通过注解创建并配置缓存</li>
<li>缓存使用的统计</li>
<li>Key生成策略与Value序列化方式自定义</li>
<li>异步CacheAPI</li>
<li>Spring Boot支持</li>
</ol>
<span id="more"></span>

<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><ol>
<li>JDK1.8</li>
<li>可选Spring Framework 4.0.8+</li>
<li>可选Spring Boot 1.1.9+</li>
</ol>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><blockquote>
<p>仅仅介绍 SpringBoot 下的使用</p>
</blockquote>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alicp.jetcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetcache-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jetcache:</span></span><br><span class="line">  <span class="attr">statIntervalMinutes:</span> <span class="number">15</span></span><br><span class="line">  <span class="attr">areaInCacheName:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">linkedhashmap</span></span><br><span class="line">      <span class="attr">keyConvertor:</span> <span class="string">fastjson</span></span><br><span class="line">  <span class="attr">remote:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">keyConvertor:</span> <span class="string">fastjson</span></span><br><span class="line">      <span class="attr">valueEncoder:</span> <span class="string">java</span></span><br><span class="line">      <span class="attr">valueDecoder:</span> <span class="string">java</span></span><br><span class="line">      <span class="attr">poolConfig:</span></span><br><span class="line">        <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">maxIdle:</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">maxTotal:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableMethodCache(basePackages = &quot;com.company.mypackage&quot;)</span></span><br><span class="line"><span class="meta">@EnableCreateCacheAnnotation</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySpringBootApp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(MySpringBootApp.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建缓存实例的方式"><a href="#创建缓存实例的方式" class="headerlink" title="创建缓存实例的方式"></a>创建缓存实例的方式</h3><h4 id="一级缓存"><a href="#一级缓存" class="headerlink" title="一级缓存"></a>一级缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CreateCache(expire = 100)</span></span><br><span class="line"><span class="keyword">private</span> Cache&lt;Long, UserDO&gt; userCache;</span><br></pre></td></tr></table></figure>

<h4 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CreateCache(name = &quot;UserService.userCache&quot;, expire = 100, cacheType = CacheType.BOTH, localLimit = 50)</span></span><br><span class="line"><span class="keyword">private</span> Cache&lt;Long, UserDO&gt; userCache;</span><br></pre></td></tr></table></figure>

<h3 id="创建方法缓存的方式"><a href="#创建方法缓存的方式" class="headerlink" title="创建方法缓存的方式"></a>创建方法缓存的方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Cached(name=&quot;UserService.getUserById&quot;, expire = 3600)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="type">long</span> userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CacheAPI"><a href="#CacheAPI" class="headerlink" title="CacheAPI"></a>CacheAPI</h2><blockquote>
<figure class="highlight plaintext"><figcaption><span>缓存的写入与读取都通过这个进行</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">基本api如下:</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">// 获取</span><br><span class="line">V get(K key)</span><br><span class="line">// 插入</span><br><span class="line">void put(K key, V value);</span><br><span class="line">// 指定过期时间</span><br><span class="line">void put(K key, V value, long expire, TimeUnit timeUnit)</span><br><span class="line">boolean putIfAbsent(K key, V value); //多级缓存MultiLevelCache不支持此方法</span><br><span class="line">boolean remove(K key);</span><br><span class="line">&lt;T&gt; T unwrap(Class&lt;T&gt; clazz);//2.2版本前，多级缓存MultiLevelCache不支持此方法</span><br><span class="line">Map&lt;K,V&gt; getAll(Set&lt;? extends K&gt; keys);</span><br><span class="line">void putAll(Map&lt;? extends K,? extends V&gt; map);</span><br><span class="line">void removeAll(Set&lt;? extends K&gt; keys);</span><br><span class="line">// 当key对应的缓存不存在时，使用loader加载。</span><br><span class="line">// cacheNullWhenLoaderReturnNull参数指定了当loader加载出来时null值的时候，是否要进行缓存（有时候即使是null值也是通过很繁重的查询才得到的，需要缓存）。</span><br><span class="line">// expire和timeUnit指定了缓存的超时时间，会覆盖缓存的默认超时时间。</span><br><span class="line">V computeIfAbsent(K key, Function&lt;K, V&gt; loader)</span><br><span class="line">V computeIfAbsent(K key, Function&lt;K, V&gt; loader, boolean cacheNullWhenLoaderReturnNull)</span><br><span class="line">V computeIfAbsent(K key, Function&lt;K, V&gt; loader, boolean cacheNullWhenLoaderReturnNull, long expire, TimeUnit timeUnit)</span><br><span class="line">// 尝试获取锁</span><br><span class="line">AutoReleaseLock tryLock(K key, long expire, TimeUnit timeUnit) //可能获取到AutoReleaseLock为null,需要自行判断</span><br><span class="line">boolean tryLockAndRun(K key, long expire, TimeUnit timeUnit, Runnable action)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="特殊的API"><a href="#特殊的API" class="headerlink" title="特殊的API"></a>特殊的API</h3><blockquote>
<p>jetCache提供了大写的API, 与小写的区别是返回一个CacheResult对象, 例如:可以通过大写的<code>GET</code>判断获取到的key不存在还是发生了异常情况导致没有获取到,还是缓存过期导致没有获取到.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CacheGetResult&lt;V&gt; <span class="title function_">GET</span><span class="params">(K key)</span>;</span><br><span class="line">MultiGetResult&lt;K, V&gt; <span class="title function_">GET_ALL</span><span class="params">(Set&lt;? extends K&gt; keys)</span>;</span><br><span class="line">CacheResult <span class="title function_">PUT</span><span class="params">(K key, V value)</span>;</span><br><span class="line">CacheResult <span class="title function_">PUT</span><span class="params">(K key, V value, <span class="type">long</span> expireAfterWrite, TimeUnit timeUnit)</span>;</span><br><span class="line">CacheResult <span class="title function_">PUT_ALL</span><span class="params">(Map&lt;? extends K, ? extends V&gt; map)</span>;</span><br><span class="line">CacheResult <span class="title function_">PUT_ALL</span><span class="params">(Map&lt;? extends K, ? extends V&gt; map, <span class="type">long</span> expireAfterWrite, TimeUnit timeUnit)</span>;</span><br><span class="line">CacheResult <span class="title function_">REMOVE</span><span class="params">(K key)</span>;</span><br><span class="line">CacheResult <span class="title function_">REMOVE_ALL</span><span class="params">(Set&lt;? extends K&gt; keys)</span>;</span><br><span class="line">CacheResult <span class="title function_">PUT_IF_ABSENT</span><span class="params">(K key, V value, <span class="type">long</span> expireAfterWrite, TimeUnit timeUnit)</span>;</span><br></pre></td></tr></table></figure>

<p>使用上要这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CacheGetResult&lt;OrderDO&gt; r = cache.GET(orderId);</span><br><span class="line"><span class="keyword">if</span>( r.isSuccess() )&#123;</span><br><span class="line">    <span class="type">OrderDO</span> <span class="variable">order</span> <span class="operator">=</span> r.getValue();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.getResultCode() == CacheResultCode.NOT_EXISTS) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;cache miss:&quot;</span> + orderId);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(r.getResultCode() == CacheResultCode.EXPIRED) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;cache expired:&quot;</span> + orderId));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;cache get error:&quot;</span> + orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注解的使用"><a href="#注解的使用" class="headerlink" title="注解的使用"></a>注解的使用</h3><h4 id="成员变量上的注解CreateCache"><a href="#成员变量上的注解CreateCache" class="headerlink" title="成员变量上的注解CreateCache"></a>成员变量上的注解CreateCache</h4><p>有如下参数:</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>area</td>
<td>“default”</td>
<td>如果需要连接多个缓存系统，可在配置多个cache area，这个属性指定要使用的那个area的name</td>
</tr>
<tr>
<td>name</td>
<td>未定义</td>
<td>指定缓存的名称，不是必须的，如果没有指定，会使用类名+方法名。name会被用于远程缓存的key前缀。另外在统计中，一个简短有意义的名字会提高可读性。如果两个<code>@CreateCache</code>的<code>name</code>和<code>area</code>相同，它们会指向同一个<code>Cache</code>实例</td>
</tr>
<tr>
<td>expire</td>
<td>未定义</td>
<td>该Cache实例的默认超时时间定义，注解上没有定义的时候会使用全局配置，如果此时全局配置也没有定义，则取无穷大</td>
</tr>
<tr>
<td>timeUnit</td>
<td>TimeUnit.SECONDS</td>
<td>指定expire的单位</td>
</tr>
<tr>
<td>cacheType</td>
<td>CacheType.REMOTE</td>
<td>缓存的类型，包括CacheType.REMOTE、CacheType.LOCAL、CacheType.BOTH。如果定义为BOTH，会使用LOCAL和REMOTE组合成两级缓存</td>
</tr>
<tr>
<td>localLimit</td>
<td>未定义</td>
<td>如果cacheType为CacheType.LOCAL或CacheType.BOTH，这个参数指定本地缓存的最大元素数量，以控制内存占用。注解上没有定义的时候会使用全局配置，如果此时全局配置也没有定义，则取100</td>
</tr>
<tr>
<td>serialPolicy</td>
<td>未定义</td>
<td>如果cacheType为CacheType.REMOTE或CacheType.BOTH，指定远程缓存的序列化方式。JetCache内置的可选值为SerialPolicy.JAVA和SerialPolicy.KRYO。注解上没有定义的时候会使用全局配置，如果此时全局配置也没有定义，则取SerialPolicy.JAVA</td>
</tr>
<tr>
<td>keyConvertor</td>
<td>未定义</td>
<td>指定KEY的转换方式，用于将复杂的KEY类型转换为缓存实现可以接受的类型，JetCache内置的可选值为KeyConvertor.FASTJSON和KeyConvertor.NONE。NONE表示不转换，FASTJSON通过fastjson将复杂对象KEY转换成String。如果注解上没有定义，则使用全局配置。</td>
</tr>
</tbody></table>
<h4 id="方法上的注解Cached-CacheUpdate-CacheInvalidate-CacheRefresh-CachePenetrationProtect"><a href="#方法上的注解Cached-CacheUpdate-CacheInvalidate-CacheRefresh-CachePenetrationProtect" class="headerlink" title="方法上的注解Cached,CacheUpdate,CacheInvalidate,CacheRefresh,CachePenetrationProtect"></a>方法上的注解Cached,CacheUpdate,CacheInvalidate,CacheRefresh,CachePenetrationProtect</h4><h5 id="Cached"><a href="#Cached" class="headerlink" title="Cached"></a>Cached</h5><table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>area</td>
<td>“default”</td>
<td>如果在配置中配置了多个缓存area，在这里指定使用哪个area</td>
</tr>
<tr>
<td>name</td>
<td>未定义</td>
<td>指定缓存的唯一名称，不是必须的，如果没有指定，会使用类名+方法名。name会被用于远程缓存的key前缀。另外在统计中，一个简短有意义的名字会提高可读性。</td>
</tr>
<tr>
<td>key</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定key，如果没有指定会根据所有参数自动生成。</td>
</tr>
<tr>
<td>expire</td>
<td>未定义</td>
<td>超时时间。如果注解上没有定义，会使用全局配置，如果此时全局配置也没有定义，则为无穷大</td>
</tr>
<tr>
<td>timeUnit</td>
<td>TimeUnit.SECONDS</td>
<td>指定expire的单位</td>
</tr>
<tr>
<td>cacheType</td>
<td>CacheType.REMOTE</td>
<td>缓存的类型，包括CacheType.REMOTE、CacheType.LOCAL、CacheType.BOTH。如果定义为BOTH，会使用LOCAL和REMOTE组合成两级缓存</td>
</tr>
<tr>
<td>localLimit</td>
<td>未定义</td>
<td>如果cacheType为LOCAL或BOTH，这个参数指定本地缓存的最大元素数量，以控制内存占用。如果注解上没有定义，会使用全局配置，如果此时全局配置也没有定义，则为100</td>
</tr>
<tr>
<td>localExpire</td>
<td>未定义</td>
<td>仅当cacheType为BOTH时适用，为内存中的Cache指定一个不一样的超时时间，通常应该小于expire</td>
</tr>
<tr>
<td>serialPolicy</td>
<td>未定义</td>
<td>指定远程缓存的序列化方式。可选值为SerialPolicy.JAVA和SerialPolicy.KRYO。如果注解上没有定义，会使用全局配置，如果此时全局配置也没有定义，则为SerialPolicy.JAVA</td>
</tr>
<tr>
<td>keyConvertor</td>
<td>未定义</td>
<td>指定KEY的转换方式，用于将复杂的KEY类型转换为缓存实现可以接受的类型，当前支持KeyConvertor.FASTJSON和KeyConvertor.NONE。NONE表示不转换，FASTJSON可以将复杂对象KEY转换成String。如果注解上没有定义，会使用全局配置。</td>
</tr>
<tr>
<td>enabled</td>
<td>true</td>
<td>是否激活缓存。例如某个dao方法上加缓存注解，由于某些调用场景下不能有缓存，所以可以设置enabled为false，正常调用不会使用缓存，在需要的地方可使用CacheContext.enableCache在回调中激活缓存，缓存激活的标记在ThreadLocal上，该标记被设置后，所有enable&#x3D;false的缓存都被激活</td>
</tr>
<tr>
<td>cacheNullValue</td>
<td>false</td>
<td>当方法返回值为null的时候是否要缓存</td>
</tr>
<tr>
<td>condition</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定条件，如果表达式返回true的时候才去缓存中查询</td>
</tr>
<tr>
<td>postCondition</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定条件，如果表达式返回true的时候才更新缓存，该评估在方法执行后进行，因此可以访问到#result</td>
</tr>
</tbody></table>
<h5 id="CacheUpdate"><a href="#CacheUpdate" class="headerlink" title="CacheUpdate"></a>CacheUpdate</h5><table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>area</td>
<td>“default”</td>
<td>如果在配置中配置了多个缓存area，在这里指定使用哪个area，指向对应的@Cached定义。</td>
</tr>
<tr>
<td>name</td>
<td>未定义</td>
<td>指定缓存的唯一名称，指向对应的@Cached定义。</td>
</tr>
<tr>
<td>key</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定key</td>
</tr>
<tr>
<td>value</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定value</td>
</tr>
<tr>
<td>condition</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定条件，如果表达式返回true才执行更新，可访问方法结果#result</td>
</tr>
</tbody></table>
<h5 id="CacheInvalidate"><a href="#CacheInvalidate" class="headerlink" title="CacheInvalidate"></a>CacheInvalidate</h5><table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>area</td>
<td>“default”</td>
<td>如果在配置中配置了多个缓存area，在这里指定使用哪个area，指向对应的@Cached定义。</td>
</tr>
<tr>
<td>name</td>
<td>未定义</td>
<td>指定缓存的唯一名称，指向对应的@Cached定义。</td>
</tr>
<tr>
<td>key</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定key</td>
</tr>
<tr>
<td>condition</td>
<td>未定义</td>
<td>使用<a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html">SpEL</a>指定条件，如果表达式返回true才执行删除，可访问方法结果#result</td>
</tr>
</tbody></table>
<h5 id="CacheRefresh"><a href="#CacheRefresh" class="headerlink" title="CacheRefresh"></a>CacheRefresh</h5><table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>refresh</td>
<td>未定义</td>
<td>刷新间隔</td>
</tr>
<tr>
<td>timeUnit</td>
<td>TimeUnit.SECONDS</td>
<td>时间单位</td>
</tr>
<tr>
<td>stopRefreshAfterLastAccess</td>
<td>未定义</td>
<td>指定该key多长时间没有访问就停止刷新，如果不指定会一直刷新</td>
</tr>
<tr>
<td>refreshLockTimeout</td>
<td>60秒</td>
<td>类型为BOTH&#x2F;REMOTE的缓存刷新时，同时只会有一台服务器在刷新，这台服务器会在远程缓存放置一个分布式锁，此配置指定该锁的超时时间</td>
</tr>
</tbody></table>
<h5 id="CachePenetrationProtect"><a href="#CachePenetrationProtect" class="headerlink" title="CachePenetrationProtect"></a>CachePenetrationProtect</h5><blockquote>
<p>放穿透机制</p>
</blockquote>
<p>当缓存访问未命中的情况下，对并发进行的加载行为进行保护。<br>当前版本实现的是单JVM内的保护，即同一个JVM中同一个key只有一个线程去加载，其它线程等待结果。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">jetcache:</span><br><span class="line">  statIntervalMinutes: 15</span><br><span class="line">  areaInCacheName: false</span><br><span class="line">  hidePackages: com.alibaba</span><br><span class="line">  local:</span><br><span class="line">    default:</span><br><span class="line">      type: caffeine</span><br><span class="line">      limit: 100</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      expireAfterWriteInMillis: 100000</span><br><span class="line">    otherArea:</span><br><span class="line">      type: linkedhashmap</span><br><span class="line">      limit: 100</span><br><span class="line">      keyConvertor: none</span><br><span class="line">      expireAfterWriteInMillis: 100000</span><br><span class="line">  remote:</span><br><span class="line">    default:</span><br><span class="line">      type: redis</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      valueEncoder: java</span><br><span class="line">      valueDecoder: java</span><br><span class="line">      poolConfig:</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxIdle: 20</span><br><span class="line">        maxTotal: 50</span><br><span class="line">      host: $&#123;redis.host&#125;</span><br><span class="line">      port: $&#123;redis.port&#125;</span><br><span class="line">    otherArea:</span><br><span class="line">      type: redis</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      valueEncoder: kryo</span><br><span class="line">      valueDecoder: kryo</span><br><span class="line">      poolConfig:</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxIdle: 20</span><br><span class="line">        maxTotal: 50</span><br><span class="line">      host: $&#123;redis.host&#125;</span><br><span class="line">      port: $&#123;redis.port&#125;</span><br></pre></td></tr></table></figure>

<p>配置通用说明如下</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>jetcache.statIntervalMinutes</code></td>
<td>0</td>
<td>统计间隔，0表示不统计</td>
</tr>
<tr>
<td><code>jetcache.areaInCacheName</code></td>
<td>true</td>
<td>jetcache-anno把cacheName作为远程缓存key前缀，2.4.3以前的版本总是把areaName加在cacheName中，因此areaName也出现在key前缀中。2.4.4以后可以配置，为了保持远程key兼容默认值为true，但是新项目的话false更合理些。</td>
</tr>
<tr>
<td><code>jetcache.hiddenPackages</code></td>
<td>无</td>
<td>@Cached和@CreateCache自动生成name的时候，为了不让name太长，hiddenPackages指定的包名前缀被截掉</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.type</code></td>
<td>无</td>
<td>缓存类型。tair、redis为当前支持的远程缓存；linkedhashmap、caffeine为当前支持的本地缓存类型</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.keyConvertor</code></td>
<td>无</td>
<td>key转换器的全局配置，当前只有一个已经实现的keyConvertor：<code>fastjson</code>。仅当使用@CreateCache且缓存类型为LOCAL时可以指定为<code>none</code>，此时通过equals方法来识别key。方法缓存必须指定keyConvertor</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.valueEncoder</code></td>
<td>java</td>
<td>序列化器的全局配置。仅remote类型的缓存需要指定，可选java和kryo</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.valueDecoder</code></td>
<td>java</td>
<td>序列化器的全局配置。仅remote类型的缓存需要指定，可选java和kryo</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.limit</code></td>
<td>100</td>
<td>每个缓存实例的最大元素的全局配置，仅local类型的缓存需要指定。注意是每个缓存实例的限制，而不是全部，比如这里指定100，然后用@CreateCache创建了两个缓存实例（并且注解上没有设置localLimit属性），那么每个缓存实例的限制都是100</td>
</tr>
<tr>
<td><code>jetcache.[local\remote].$&#123;area&#125;.expireAfterWriteInMillis</code></td>
<td>无穷大</td>
<td>以毫秒为单位指定超时时间的全局配置(以前为defaultExpireInMillis)</td>
</tr>
<tr>
<td><code>jetcache.local.$&#123;area&#125;.expireAfterAccessInMillis</code></td>
<td>0</td>
<td>需要jetcache2.2以上，以毫秒为单位，指定多长时间没有访问，就让缓存失效，当前只有本地缓存支持。0表示不使用这个功能。</td>
</tr>
</tbody></table>
<blockquote>
<p>上表中${area}对应@Cached和@CreateCache的area属性。注意如果注解上没有指定area，默认值是”default”。</p>
</blockquote>
<blockquote>
<p>多个地方能配置过期时间,优先级为: 方法传参&gt;注解参数&gt;全局参数</p>
</blockquote>
<h3 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h3><h4 id="异步API"><a href="#异步API" class="headerlink" title="异步API"></a>异步API</h4><p>大写API会返回CacheGetResult对象,CacheGetResult对象的<code>future()</code>方法可以返回一个CompletionStage,能支持异步调用某些逻辑.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CacheGetResult&lt;UserDO&gt; r = cache.GET(userId);</span><br><span class="line">CompletionStage&lt;ResultData&gt; future = r.future();</span><br><span class="line">future.thenRun(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(r.isSuccess())&#123;</span><br><span class="line">        System.out.println(r.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>无返回值的操作使用异步调用,能减少RT</p>
</blockquote>
<h4 id="自动load"><a href="#自动load" class="headerlink" title="自动load"></a>自动load</h4><p>Cache的get方法有时候会出现没有命中的情况, 可以设置一个loader, 没有命中时自动的加载.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loadUserFromDatabase</span></span><br><span class="line">Cache&lt;Long,UserDO&gt; userCache = LinkedHashMapCacheBuilder.createLinkedHashMapCacheBuilder()</span><br><span class="line">                .loader(key -&gt; loadUserFromDatabase(key))</span><br><span class="line">                .buildCache();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果loader抛出异常，get和getAll会抛出CacheInvokeException。</p>
</blockquote>
<blockquote>
<p>大写GET,GET_ALL不调用loader; 使用多级缓存时, loader不要设置到子Cache中, 应该是父Cache(MultiLevelCache)上</p>
</blockquote>
<blockquote>
<p>@CreateCache情况下使用, 例子如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@CreateCache</span><br><span class="line">private Cache&lt;Long,UserDO&gt; userCache;</span><br><span class="line"></span><br><span class="line">@PostConstruct</span><br><span class="line">public void init()&#123;</span><br><span class="line">    userCache.config().setLoader(this::loadUserFromDatabase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自动刷新缓存"><a href="#自动刷新缓存" class="headerlink" title="自动刷新缓存"></a>自动刷新缓存</h4><p>能设置刷新策略, 防止缓存过期.</p>
<blockquote>
<p>@CreateCache情况下使用, 例子如下</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CreateCache</span></span><br><span class="line"><span class="keyword">private</span> Cache&lt;String, Long&gt; orderSumCache;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">RefreshPolicy</span> <span class="variable">policy</span> <span class="operator">=</span> RefreshPolicy.newPolicy(<span class="number">1</span>, TimeUnit.MINUTES)</span><br><span class="line">                          .stopRefreshAfterLastAccess(<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    orderSumCache.config().setLoader(<span class="built_in">this</span>::loadOrderSumFromDatabase);</span><br><span class="line">    orderSumCache.config().setRefreshPolicy(policy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="远程缓存"><a href="#远程缓存" class="headerlink" title="远程缓存"></a>远程缓存</h3><h4 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h4><blockquote>
<p>jetcache-starter-redis</p>
</blockquote>
<p>配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">jetcache: </span><br><span class="line">  areaInCacheName: false</span><br><span class="line">  remote:</span><br><span class="line">    default:</span><br><span class="line">      type: redis</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      poolConfig:</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxIdle: 20</span><br><span class="line">        maxTotal: 50</span><br><span class="line">      host: $&#123;redis.host&#125;</span><br><span class="line">      port: $&#123;redis.port&#125;</span><br><span class="line">      #password:***</span><br><span class="line">      #sentinels: 127.0.0.1:26379 , 127.0.0.1:26380, 127.0.0.1:26381</span><br><span class="line">      #masterName: mymaster</span><br></pre></td></tr></table></figure>

<p>如果需要直接操作JedisPool，可以通过以下方式获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;defaultPool&quot;)</span></span><br><span class="line"><span class="meta">@DependsOn(RedisAutoConfiguration.AUTO_INIT_BEAN_NAME)</span></span><br><span class="line"><span class="keyword">public</span> JedisPoolFactory <span class="title function_">defaultPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisPoolFactory</span>(<span class="string">&quot;remote.default&quot;</span>, JedisPool.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后可以直接使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> Pool&lt;Jedis&gt; defaultPool;</span><br></pre></td></tr></table></figure>

<h4 id="Lettuce"><a href="#Lettuce" class="headerlink" title="Lettuce"></a>Lettuce</h4><blockquote>
<p>jetcache-starter-redis-lettuce</p>
</blockquote>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">jetcache: </span><br><span class="line">  areaInCacheName: false</span><br><span class="line">  remote:</span><br><span class="line">    default:</span><br><span class="line">      type: redis.lettuce</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      uri: redis://127.0.0.1:6379/</span><br><span class="line">      #uri: redis-sentinel://127.0.0.1:26379,127.0.0.1:26380,127.0.0.1:26381/?sentinelMasterId=mymaster</span><br><span class="line">      #readFrom: slavePreferred</span><br><span class="line"># 集群使用如下</span><br><span class="line">jetcache: </span><br><span class="line">  areaInCacheName: false</span><br><span class="line">  remote:</span><br><span class="line">    default:</span><br><span class="line">      type: redis.lettuce</span><br><span class="line">      keyConvertor: fastjson</span><br><span class="line">      #readFrom: slavePreferred</span><br><span class="line">      uri:</span><br><span class="line">        - redis://127.0.0.1:7000</span><br><span class="line">        - redis://127.0.0.1:7001</span><br><span class="line">        - redis://127.0.0.1:7002</span><br></pre></td></tr></table></figure>

<p>如果需要直接使用lettuce的RedisClient：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;defaultClient&quot;)</span></span><br><span class="line"><span class="meta">@DependsOn(RedisLettuceAutoConfiguration.AUTO_INIT_BEAN_NAME)</span></span><br><span class="line"><span class="keyword">public</span> LettuceFactory <span class="title function_">defaultClient</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceFactory</span>(<span class="string">&quot;remote.default&quot;</span>, RedisClient.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后可以直接使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisClient defaultClient;</span><br></pre></td></tr></table></figure>

<h3 id="本地缓存"><a href="#本地缓存" class="headerlink" title="本地缓存"></a>本地缓存</h3><h4 id="LinkedHashMapCache"><a href="#LinkedHashMapCache" class="headerlink" title="LinkedHashMapCache"></a>LinkedHashMapCache</h4><p>LinkedHashMapCache是JetCache中实现的一个最简单的Cache，使用LinkedHashMap做LRU方式淘汰。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;Long, OrderDO&gt; cache = LinkedHashMapCacheBuilder.createLinkedHashMapCacheBuilder()</span><br><span class="line">                .limit(<span class="number">100</span>)</span><br><span class="line">                .expireAfterWrite(<span class="number">200</span>, TimeUnit.SECONDS)</span><br><span class="line">                .buildCache();</span><br></pre></td></tr></table></figure>

<h4 id="CaffeineCache"><a href="#CaffeineCache" class="headerlink" title="CaffeineCache"></a>CaffeineCache</h4><p>caffeine cache的介绍看<a href="https://github.com/ben-manes/caffeine">这里</a>，它是guava cache的后续作品。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;Long, OrderDO&gt; cache = CaffeineCacheBuilder.createCaffeineCacheBuilder()</span><br><span class="line">                .limit(<span class="number">100</span>)</span><br><span class="line">                .expireAfterWrite(<span class="number">200</span>, TimeUnit.SECONDS)</span><br><span class="line">                .buildCache();</span><br></pre></td></tr></table></figure>

<h3 id="缓存的统计与监控"><a href="#缓存的统计与监控" class="headerlink" title="缓存的统计与监控"></a>缓存的统计与监控</h3><p>jetcache.statIntervalMinutes大于0时, jetCache会自动在日志上打印缓存的使用情况.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2017-01-12 19:00:00,001 INFO  support.StatInfoLogger - jetcache stat from 2017-01-12 18:59:00,000 to 2017-01-12 19:00:00,000</span><br><span class="line">cache                                                |       qps|   rate|           get|           hit|          fail|        expire|avgLoadTime|maxLoadTime</span><br><span class="line">-----------------------------------------------------+----------+-------+--------------+--------------+--------------+--------------+-----------+-----------</span><br><span class="line">default_AlicpAppChannelManager.getAlicpAppChannelById|      0.00|  0.00%|             0|             0|             0|             0|        0.0|          0</span><br><span class="line">.....</span><br><span class="line">-----------------------------------------------------+----------+-------+--------------+--------------+--------------+--------------+-----------+-----------</span><br></pre></td></tr></table></figure>
<p>只有使用computeIfAbsent方法或者@Cached注解才会统计loadTime。用get方法取缓存，没有命中的话自己去数据库load，显然是无法统计到的。</p>
<p>也可以自定义输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for 2.6+</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Consumer&lt;StatInfo&gt; <span class="title function_">metricsCallback</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Consumer&lt;StatInfo&gt; <span class="title function_">statCallback</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// return new StatInfoLogger(false);</span></span><br><span class="line">        ... <span class="comment">// 实现自己的logger</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for 2.5</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SpringConfigProvider <span class="title function_">springConfigProvider</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringConfigProvider</span>()&#123;</span><br><span class="line">        <span class="keyword">public</span> Consumer&lt;StatInfo&gt; <span class="title function_">statCallback</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// return new StatInfoLogger(false);</span></span><br><span class="line">            ... <span class="comment">// 实现自己的logger</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以输出成单独的log文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;JETCACHE_LOGFILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>jetcache.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>jetcache.log.%d&#123;yyyy-MM-dd&#125;<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;35&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.alicp.jetcache&quot;</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;JETCACHE_LOGFILE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="不使用注解"><a href="#不使用注解" class="headerlink" title="不使用注解"></a>不使用注解</h3><p>不使用注解来创建缓存实例要利用各种Builder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 本地</span></span><br><span class="line">Cache&lt;String, Integer&gt; cache = LinkedHashMapCacheBuilder.createLinkedHashMapCacheBuilder()</span><br><span class="line">                .limit(<span class="number">100</span>)</span><br><span class="line">                .expireAfterWrite(<span class="number">200</span>, TimeUnit.SECONDS)</span><br><span class="line">                .buildCache();</span><br><span class="line"><span class="comment">// redis</span></span><br><span class="line"><span class="type">GenericObjectPoolConfig</span> <span class="variable">pc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericObjectPoolConfig</span>();</span><br><span class="line">        pc.setMinIdle(<span class="number">2</span>);</span><br><span class="line">        pc.setMaxIdle(<span class="number">10</span>);</span><br><span class="line">        pc.setMaxTotal(<span class="number">10</span>);</span><br><span class="line">        <span class="type">JedisPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JedisPool</span>(pc, <span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">Cache&lt;Long, OrderDO&gt; orderCache = RedisCacheBuilder.createRedisCacheBuilder()</span><br><span class="line">                .keyConvertor(FastjsonKeyConvertor.INSTANCE)</span><br><span class="line">                .valueEncoder(JavaValueEncoder.INSTANCE)</span><br><span class="line">                .valueDecoder(JavaValueDecoder.INSTANCE)</span><br><span class="line">                .jedisPool(pool)</span><br><span class="line">                .keyPrefix(<span class="string">&quot;orderCache&quot;</span>)</span><br><span class="line">                .expireAfterWrite(<span class="number">200</span>, TimeUnit.SECONDS)</span><br><span class="line">                .buildCache();</span><br><span class="line"><span class="comment">// 多级</span></span><br><span class="line"><span class="type">Cache</span> <span class="variable">multiLevelCache</span> <span class="operator">=</span> MultiLevelCacheBuilder.createMultiLevelCacheBuilder()</span><br><span class="line">      .addCache(memoryCache, redisCache)</span><br><span class="line">      .expireAfterWrite(<span class="number">100</span>, TimeUnit.SECONDS)</span><br><span class="line">      .buildCache();</span><br></pre></td></tr></table></figure>

<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>key、condition等表达式中使用参数名需要javac命令的<code>-parameters</code>支持  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">compilerArgument</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">compilerArgument</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>自定义序列化器可以自定义SpringConfigProvider的Bean,实现<code>parseValueEncoder</code>和<code>parseValueDecoder</code>方法</li>
</ol>
<h3 id="看源码"><a href="#看源码" class="headerlink" title="看源码"></a>看源码</h3><p>Cache的实现:</p>
<ul>
<li>RedisCache: redis实现，使用jedis客户端</li>
<li>RedisLettuceCache： redis实现，使用lettuce客户端</li>
<li>CaffeineCache: 基于内存的缓存，使用Caffeine</li>
<li>LinkedHashMapCache: 自制的简易内存缓存，没有任何依赖</li>
<li>LoadingCache：基于Decorator模式，提供自动加载功能</li>
<li>RefreshCache：基于Decorator模式，提供自动刷新功能</li>
<li>MultiLevelCache：多级缓存，注解方式配置只支持了两级，实际上这个类支持N级</li>
</ul>
<p>jetcache-anno提供了注解支持，顺着这两个注解类看就可以了：</p>
<ul>
<li>EnableCreateCacheAnnotation</li>
<li>EnableMethodCache</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.canyuda.top/posts/2021040520009/" data-id="clsbg7ims008wu8ol5vxu5umm" data-title="JetCache的使用" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cache/" rel="tag">缓存</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/posts/2021040542562/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">前一篇</strong>
      <div class="article-nav-title">
        
          JetCache的源码
        
      </div>
    </a>
  
  
    <a href="/posts/2020112522511/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">后一篇</strong>
      <div class="article-nav-title">设计模式-组合模式</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/front-end/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/industrial-control/">工业控制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/database/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/data-structures-algorithms/">数据结构与算法</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hystrix/" rel="tag">Hystrix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Web/" rel="tag">Java Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/" rel="tag">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/" rel="tag">Spring Boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-cloud/" rel="tag">Spring-Cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/myporject/" rel="tag">个人项目</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offer-book/" rel="tag">剑指offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chart/" rel="tag">图表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/base/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tips/" rel="tag">小知识</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sort-and-find/" rel="tag">排序与查找</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/search/" rel="tag">搜索</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authority/" rel="tag">权限</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/catalogue/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/" rel="tag">缓存</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plan/" rel="tag">计划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-mode/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/communication-protocol/" rel="tag">通讯协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrent/" rel="tag">高并发</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Hystrix/" style="font-size: 10.91px;">Hystrix</a> <a href="/tags/jvm/" style="font-size: 16.36px;">JVM</a> <a href="/tags/Java-Web/" style="font-size: 13.64px;">Java Web</a> <a href="/tags/mybatis/" style="font-size: 10.91px;">MyBatis</a> <a href="/tags/MySQL/" style="font-size: 10.91px;">MySQL</a> <a href="/tags/oracle/" style="font-size: 10px;">Oracle</a> <a href="/tags/spring/" style="font-size: 17.27px;">Spring</a> <a href="/tags/Spring-Boot/" style="font-size: 10px;">Spring Boot</a> <a href="/tags/spring-cloud/" style="font-size: 10.91px;">Spring-Cloud</a> <a href="/tags/myporject/" style="font-size: 14.55px;">个人项目</a> <a href="/tags/offer-book/" style="font-size: 18.18px;">剑指offer</a> <a href="/tags/chart/" style="font-size: 15.45px;">图表</a> <a href="/tags/base/" style="font-size: 20px;">基础</a> <a href="/tags/tips/" style="font-size: 13.64px;">小知识</a> <a href="/tags/sort-and-find/" style="font-size: 12.73px;">排序与查找</a> <a href="/tags/search/" style="font-size: 10px;">搜索</a> <a href="/tags/authority/" style="font-size: 10px;">权限</a> <a href="/tags/catalogue/" style="font-size: 11.82px;">目录</a> <a href="/tags/cache/" style="font-size: 10.91px;">缓存</a> <a href="/tags/plan/" style="font-size: 11.82px;">计划</a> <a href="/tags/design-mode/" style="font-size: 19.09px;">设计模式</a> <a href="/tags/communication-protocol/" style="font-size: 10px;">通讯协议</a> <a href="/tags/concurrent/" style="font-size: 12.73px;">高并发</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/posts/2022113049586/">索引下推</a>
          </li>
        
          <li>
            <a href="/posts/2022112963116/">Explain详解</a>
          </li>
        
          <li>
            <a href="/posts/2022091136394/">分布式系统（十一）</a>
          </li>
        
          <li>
            <a href="/posts/2022091023774/">分布式系统（十）</a>
          </li>
        
          <li>
            <a href="/posts/2022090955657/">分布式系统（九）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 灿若繁星先生<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>